name: Sync GitHub Issue To Linear

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    if: ${{ !github.event.issue.pull_request }}
    env:
      LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
      LINEAR_TEAM_ID: ${{ vars.LINEAR_TEAM_ID }}
      LINEAR_PROJECT_ID: ${{ vars.LINEAR_PROJECT_ID }}
    steps:
      - name: Validate configuration
        run: |
          if [ -z "${LINEAR_API_KEY:-}" ]; then
            echo "Missing required secret: LINEAR_API_KEY"
            exit 1
          fi
          if [ -z "${LINEAR_TEAM_ID:-}" ]; then
            echo "Missing required repo variable: LINEAR_TEAM_ID"
            exit 1
          fi
          if [ -z "${LINEAR_PROJECT_ID:-}" ]; then
            echo "Missing required repo variable: LINEAR_PROJECT_ID"
            exit 1
          fi

      - name: Create Linear issue
        id: linear
        run: |
          ISSUE_NUMBER="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
          ISSUE_TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
          ISSUE_BODY="$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")"
          ISSUE_URL="$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")"

          LINEAR_TITLE="[GH#${ISSUE_NUMBER}] ${ISSUE_TITLE}"
          LINEAR_DESCRIPTION="$(cat <<EOF
GitHub source: ${ISSUE_URL}

Repository: ${GITHUB_REPOSITORY}
Created from GitHub issue automation.

Original issue body:
${ISSUE_BODY}
EOF
)"

          GRAPHQL_PAYLOAD="$(jq -n \
            --arg teamId "$LINEAR_TEAM_ID" \
            --arg projectId "$LINEAR_PROJECT_ID" \
            --arg title "$LINEAR_TITLE" \
            --arg description "$LINEAR_DESCRIPTION" \
            '{
              query: "mutation($input: IssueCreateInput!){ issueCreate(input:$input){ success issue { id identifier title url } } }",
              variables: {
                input: {
                  teamId: $teamId,
                  projectId: $projectId,
                  title: $title,
                  description: $description
                }
              }
            }'
          )"

          RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: ${LINEAR_API_KEY}" \
            --data-binary "$GRAPHQL_PAYLOAD")"

          SUCCESS="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.success // false')"
          if [ "$SUCCESS" != "true" ]; then
            echo "Linear issueCreate failed:"
            echo "$RESPONSE"
            exit 1
          fi

          LINEAR_ID="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.id')"
          LINEAR_IDENTIFIER="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')"
          LINEAR_URL="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.url')"

          echo "linear_id=${LINEAR_ID}" >> "$GITHUB_OUTPUT"
          echo "linear_identifier=${LINEAR_IDENTIFIER}" >> "$GITHUB_OUTPUT"
          echo "linear_url=${LINEAR_URL}" >> "$GITHUB_OUTPUT"

      - name: Comment on GitHub issue with Linear link
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const linearIdentifier = `${{ steps.linear.outputs.linear_identifier }}`;
            const linearUrl = `${{ steps.linear.outputs.linear_url }}`;

            const body = [
              'Linear tracking created automatically.',
              '',
              `- ${linearIdentifier}: ${linearUrl}`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body,
            });
