name: Sync CE PR Merge To Linear Done

on:
  pull_request:
    branches: [development]
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Merged PR number to backfill (optional)"
        required: false
        type: string
      ce_identifiers:
        description: "Optional CE identifiers to process (space/comma/newline separated)"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  sync-linear-done:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'development' && startsWith(github.event.pull_request.head.ref, 'codex/CE-')) || github.event_name == 'workflow_dispatch' }}
    env:
      LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
      LINEAR_TEAM_ID: ${{ vars.LINEAR_TEAM_ID }}
    steps:
      - name: Validate configuration
        run: |
          if [ -z "${LINEAR_API_KEY:-}" ]; then
            echo "Missing required secret: LINEAR_API_KEY"
            exit 1
          fi
          if [ -z "${LINEAR_TEAM_ID:-}" ]; then
            echo "Missing required repo variable: LINEAR_TEAM_ID"
            exit 1
          fi

      - name: Load PR context
        id: pr
        uses: actions/github-script@v7
        env:
          INPUT_PR_NUMBER: ${{ inputs.pr_number }}
        with:
          script: |
            const isDispatch = context.eventName === 'workflow_dispatch';
            let pr = null;

            if (isDispatch && process.env.INPUT_PR_NUMBER) {
              const prNumber = Number(process.env.INPUT_PR_NUMBER || '0');
              if (!prNumber) {
                core.setFailed('workflow_dispatch input pr_number must be numeric when provided.');
                return;
              }

              const response = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              pr = response.data;
            } else if (!isDispatch) {
              pr = context.payload.pull_request;
            }

            if (pr) {
              if (!pr.merged) {
                core.setFailed(`PR #${pr.number} is not merged.`);
                return;
              }
              if (pr.base?.ref !== 'development') {
                core.setFailed(`PR #${pr.number} base is ${pr.base?.ref}; expected development.`);
                return;
              }
              if (!String(pr.head?.ref || '').startsWith('codex/CE-')) {
                core.setFailed(`PR #${pr.number} head ref is ${pr.head?.ref}; expected codex/CE-...`);
                return;
              }

              core.setOutput('pr_number', String(pr.number));
              core.setOutput('pr_title', pr.title || '');
              core.setOutput('pr_body', pr.body || '');
              core.setOutput('head_ref', pr.head?.ref || '');
              core.setOutput('pr_url', pr.html_url || '');
              return;
            }

            core.setOutput('pr_number', '');
            core.setOutput('pr_title', '');
            core.setOutput('pr_body', '');
            core.setOutput('head_ref', '');
            core.setOutput('pr_url', '');

      - name: Collect CE identifiers
        id: ce
        env:
          PR_TITLE: ${{ steps.pr.outputs.pr_title }}
          PR_BODY: ${{ steps.pr.outputs.pr_body }}
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
          INPUT_CE_IDENTIFIERS: ${{ inputs.ce_identifiers }}
        run: |
          {
            printf '%s\n' "$PR_TITLE"
            printf '%s\n' "$PR_BODY"
            printf '%s\n' "$HEAD_REF"
            printf '%s\n' "$INPUT_CE_IDENTIFIERS"
          } \
            | tr '[:lower:]' '[:upper:]' \
            | grep -Eo 'CE-[0-9]+' \
            | grep -E '^CE-[0-9]+$' \
            | sort -u > ce_ids.txt || true

          COUNT="$(wc -l < ce_ids.txt | tr -d ' ')"
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"

          echo "Discovered ${COUNT} CE identifier(s)."
          if [ "$COUNT" -gt 0 ]; then
            sed 's/^/- /' ce_ids.txt
          fi

      - name: Resolve Linear completed state id
        id: done_state
        if: ${{ steps.ce.outputs.count != '0' }}
        run: |
          GRAPHQL_PAYLOAD="$(jq -n \
            --arg teamId "$LINEAR_TEAM_ID" \
            '{
              query: "query($teamId:String!){ team(id:$teamId){ states{nodes{id name type}} } }",
              variables: { teamId: $teamId }
            }'
          )"

          RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: ${LINEAR_API_KEY}" \
            --data-binary "$GRAPHQL_PAYLOAD")"

          if [ "$(printf '%s' "$RESPONSE" | jq 'has("errors")')" = "true" ]; then
            echo "Linear GraphQL error while resolving completed state:"
            echo "$RESPONSE"
            exit 1
          fi

          DONE_STATE_ID="$(printf '%s' "$RESPONSE" | jq -r '.data.team.states.nodes[]? | select(.type=="completed") | .id' | head -n 1)"
          if [ -z "$DONE_STATE_ID" ] || [ "$DONE_STATE_ID" = "null" ]; then
            echo "Could not resolve completed state id for team ${LINEAR_TEAM_ID}."
            echo "$RESPONSE"
            exit 1
          fi

          echo "done_state_id=${DONE_STATE_ID}" >> "$GITHUB_OUTPUT"

      - name: Sync CE issues to Done
        if: ${{ steps.ce.outputs.count != '0' }}
        env:
          DONE_STATE_ID: ${{ steps.done_state.outputs.done_state_id }}
        run: |
          total=0
          updated=0
          already_done=0
          not_found=0
          failed=0

          while IFS= read -r CE_ID; do
            [ -z "$CE_ID" ] && continue
            total=$((total + 1))
            echo "Processing ${CE_ID}..."

            ISSUE_QUERY_PAYLOAD="$(jq -n \
              --arg identifier "$CE_ID" \
              '{
                query: "query($identifier:String!){ issue(id:$identifier){ id identifier url state { id type name } } }",
                variables: { identifier: $identifier }
              }'
            )"

            ISSUE_RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
              -H "Content-Type: application/json" \
              -H "Authorization: ${LINEAR_API_KEY}" \
              --data-binary "$ISSUE_QUERY_PAYLOAD")" || {
                echo "[${CE_ID}] Failed to query Linear API."
                failed=$((failed + 1))
                continue
              }

            if [ "$(printf '%s' "$ISSUE_RESPONSE" | jq 'has("errors")')" = "true" ]; then
              echo "[${CE_ID}] GraphQL error while fetching issue:"
              echo "$ISSUE_RESPONSE"
              failed=$((failed + 1))
              continue
            fi

            ISSUE_ID="$(printf '%s' "$ISSUE_RESPONSE" | jq -r '.data.issue.id // empty')"
            ISSUE_IDENTIFIER="$(printf '%s' "$ISSUE_RESPONSE" | jq -r '.data.issue.identifier // empty')"
            ISSUE_URL="$(printf '%s' "$ISSUE_RESPONSE" | jq -r '.data.issue.url // empty')"
            ISSUE_STATE_TYPE="$(printf '%s' "$ISSUE_RESPONSE" | jq -r '.data.issue.state.type // empty')"

            if [ -z "$ISSUE_ID" ]; then
              echo "[${CE_ID}] Not found in Linear."
              not_found=$((not_found + 1))
              continue
            fi

            if [ "$ISSUE_STATE_TYPE" = "completed" ]; then
              echo "[${ISSUE_IDENTIFIER}] Already completed (${ISSUE_URL})."
              already_done=$((already_done + 1))
              continue
            fi

            UPDATE_PAYLOAD="$(jq -n \
              --arg id "$ISSUE_ID" \
              --arg stateId "$DONE_STATE_ID" \
              '{
                query: "mutation($id:String!, $input: IssueUpdateInput!){ issueUpdate(id:$id,input:$input){ success issue { id identifier url state { type name } } } }",
                variables: {
                  id: $id,
                  input: { stateId: $stateId }
                }
              }'
            )"

            UPDATE_RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
              -H "Content-Type: application/json" \
              -H "Authorization: ${LINEAR_API_KEY}" \
              --data-binary "$UPDATE_PAYLOAD")" || {
                echo "[${CE_ID}] Failed to update Linear issue state."
                failed=$((failed + 1))
                continue
              }

            if [ "$(printf '%s' "$UPDATE_RESPONSE" | jq 'has("errors")')" = "true" ]; then
              echo "[${CE_ID}] GraphQL error while updating issue:"
              echo "$UPDATE_RESPONSE"
              failed=$((failed + 1))
              continue
            fi

            SUCCESS="$(printf '%s' "$UPDATE_RESPONSE" | jq -r '.data.issueUpdate.success // false')"
            if [ "$SUCCESS" != "true" ]; then
              echo "[${CE_ID}] Linear issue update returned success=false."
              echo "$UPDATE_RESPONSE"
              failed=$((failed + 1))
              continue
            fi

            UPDATED_IDENTIFIER="$(printf '%s' "$UPDATE_RESPONSE" | jq -r '.data.issueUpdate.issue.identifier // $identifier' --arg identifier "$CE_ID")"
            UPDATED_URL="$(printf '%s' "$UPDATE_RESPONSE" | jq -r '.data.issueUpdate.issue.url // ""')"
            echo "[${UPDATED_IDENTIFIER}] Updated to Done (${UPDATED_URL})."
            updated=$((updated + 1))
          done < ce_ids.txt

          echo "Summary: total=${total}, updated=${updated}, already_done=${already_done}, not_found=${not_found}, failed=${failed}"

          if [ "$failed" -gt 0 ]; then
            echo "One or more CE identifiers failed due to infrastructure/API errors."
            exit 1
          fi

      - name: No CE identifiers found
        if: ${{ steps.ce.outputs.count == '0' }}
        run: echo "No CE identifiers discovered. Nothing to update."
