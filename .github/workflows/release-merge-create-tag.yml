name: Release Merge Create Tag

on:
  pull_request:
    branches: [master]
    types: [closed]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-release-tag:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'master' && github.event.pull_request.head.ref == 'development' }}
    concurrency:
      group: release-merge-tag-${{ github.event.pull_request.number }}
      cancel-in-progress: false
    env:
      LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
      LINEAR_TEAM_ID: ${{ vars.LINEAR_TEAM_ID }}
      LINEAR_PROJECT_ID: ${{ vars.LINEAR_PROJECT_ID }}
    steps:
      - name: Validate configuration
        run: |
          if [ -z "${LINEAR_API_KEY:-}" ]; then
            echo "Missing required secret: LINEAR_API_KEY"
            exit 1
          fi
          if [ -z "${LINEAR_TEAM_ID:-}" ]; then
            echo "Missing required repo variable: LINEAR_TEAM_ID"
            exit 1
          fi
          if [ -z "${LINEAR_PROJECT_ID:-}" ]; then
            echo "Missing required repo variable: LINEAR_PROJECT_ID"
            exit 1
          fi

      - name: Build release context
        id: context
        run: |
          PR_NUMBER="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
          PR_TITLE="$(jq -r '.pull_request.title // ""' "$GITHUB_EVENT_PATH")"
          PR_BODY="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"
          PR_URL="$(jq -r '.pull_request.html_url // ""' "$GITHUB_EVENT_PATH")"
          MERGE_SHA="$(jq -r '.pull_request.merge_commit_sha // ""' "$GITHUB_EVENT_PATH")"

          if [ -z "$MERGE_SHA" ] || [ "$MERGE_SHA" = "null" ]; then
            echo "Missing merge commit SHA in pull_request payload."
            exit 1
          fi

          VERSION="$(printf '%s\n%s\n' "$PR_TITLE" "$PR_BODY" | grep -Eo 'v[0-9]+([.][0-9]+){0,3}([-.][A-Za-z0-9._]+)?' | head -n 1 || true)"
          if [ -z "$VERSION" ]; then
            echo "Could not find release version tag (example: v8.1) in PR title/body."
            exit 1
          fi

          TAG_NAME="$VERSION"
          TAG_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME}"

          LINEAR_TITLE="[Release Tag ${TAG_NAME}] ${GITHUB_REPOSITORY}"
          LINEAR_DESCRIPTION="$(printf '%s\n' \
            "Automated release tag tracking from merged development -> master PR." \
            "" \
            "Repository: ${GITHUB_REPOSITORY}" \
            "Tag: ${TAG_NAME}" \
            "Release URL: ${TAG_URL}" \
            "Commit SHA: ${MERGE_SHA}" \
            "Source PR: ${PR_URL}" \
            "PR number: #${PR_NUMBER}" \
            "PR title: ${PR_TITLE}" \
            "Workflow run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            "Updated at (UTC): $(date -u +%Y-%m-%dT%H:%M:%SZ)")"

          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "tag_url=${TAG_URL}" >> "$GITHUB_OUTPUT"
          echo "merge_sha=${MERGE_SHA}" >> "$GITHUB_OUTPUT"
          echo "linear_title=${LINEAR_TITLE}" >> "$GITHUB_OUTPUT"
          DELIMITER="EOF_$(date +%s)_$RANDOM"
          {
            echo "linear_description<<${DELIMITER}"
            echo "${LINEAR_DESCRIPTION}"
            echo "${DELIMITER}"
          } >> "$GITHUB_OUTPUT"

      - name: Find existing Linear tag mapping comment on PR
        id: mapping
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.pull_request.number;
            const markerId = /<!--\s*linear-release-tag-ticket-id:([^\s>]+)\s*-->/i;
            const markerIdentifier = /<!--\s*linear-release-tag-ticket-identifier:([^\s>]+)\s*-->/i;
            const markerUrl = /<!--\s*linear-release-tag-ticket-url:([^\s>]+)\s*-->/i;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const found = comments.find((comment) => markerId.test(comment.body || ""));
            if (!found) {
              core.setOutput('comment_id', '');
              core.setOutput('linear_id', '');
              core.setOutput('linear_identifier', '');
              core.setOutput('linear_url', '');
              return;
            }

            const body = found.body || '';
            const linearId = body.match(markerId)?.[1] || '';
            const linearIdentifier = body.match(markerIdentifier)?.[1] || '';
            const linearUrl = body.match(markerUrl)?.[1] || '';

            core.setOutput('comment_id', String(found.id));
            core.setOutput('linear_id', linearId);
            core.setOutput('linear_identifier', linearIdentifier);
            core.setOutput('linear_url', linearUrl);

      - name: Create tag if missing
        id: tag
        uses: actions/github-script@v7
        env:
          TAG_NAME: ${{ steps.context.outputs.tag_name }}
          MERGE_SHA: ${{ steps.context.outputs.merge_sha }}
        with:
          script: |
            const tagName = process.env.TAG_NAME;
            const mergeSha = process.env.MERGE_SHA;

            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`,
              });
              core.info(`Tag ${tagName} already exists. Skipping creation.`);
              core.setOutput('tag_action', 'already_exists');
              return;
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tagName}`,
              sha: mergeSha,
            });

            core.info(`Created tag ${tagName} -> ${mergeSha}`);
            core.setOutput('tag_action', 'created');

      - name: Upsert Linear release tag issue
        id: linear
        env:
          LINEAR_TITLE: ${{ steps.context.outputs.linear_title }}
          LINEAR_DESCRIPTION: ${{ steps.context.outputs.linear_description }}
          EXISTING_LINEAR_ID: ${{ steps.mapping.outputs.linear_id }}
        run: |
          if [ -n "$EXISTING_LINEAR_ID" ]; then
            GRAPHQL_PAYLOAD="$(jq -n \
              --arg id "$EXISTING_LINEAR_ID" \
              --arg title "$LINEAR_TITLE" \
              --arg description "$LINEAR_DESCRIPTION" \
              '{
                query: "mutation($id:String!, $input: IssueUpdateInput!){ issueUpdate(id:$id,input:$input){ success issue { id identifier title url } } }",
                variables: {
                  id: $id,
                  input: {
                    title: $title,
                    description: $description
                  }
                }
              }'
            )"

            RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
              -H "Content-Type: application/json" \
              -H "Authorization: ${LINEAR_API_KEY}" \
              --data-binary "$GRAPHQL_PAYLOAD")"

            SUCCESS="$(printf '%s' "$RESPONSE" | jq -r '.data.issueUpdate.success // false')"
            if [ "$SUCCESS" != "true" ]; then
              echo "Linear issueUpdate failed:"
              echo "$RESPONSE"
              exit 1
            fi

            LINEAR_ID="$(printf '%s' "$RESPONSE" | jq -r '.data.issueUpdate.issue.id')"
            LINEAR_IDENTIFIER="$(printf '%s' "$RESPONSE" | jq -r '.data.issueUpdate.issue.identifier')"
            LINEAR_URL="$(printf '%s' "$RESPONSE" | jq -r '.data.issueUpdate.issue.url')"
            ACTION="updated"
          else
            GRAPHQL_PAYLOAD="$(jq -n \
              --arg teamId "$LINEAR_TEAM_ID" \
              --arg projectId "$LINEAR_PROJECT_ID" \
              --arg title "$LINEAR_TITLE" \
              --arg description "$LINEAR_DESCRIPTION" \
              '{
                query: "mutation($input: IssueCreateInput!){ issueCreate(input:$input){ success issue { id identifier title url } } }",
                variables: {
                  input: {
                    teamId: $teamId,
                    projectId: $projectId,
                    title: $title,
                    description: $description
                  }
                }
              }'
            )"

            RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
              -H "Content-Type: application/json" \
              -H "Authorization: ${LINEAR_API_KEY}" \
              --data-binary "$GRAPHQL_PAYLOAD")"

            SUCCESS="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.success // false')"
            if [ "$SUCCESS" != "true" ]; then
              echo "Linear issueCreate failed:"
              echo "$RESPONSE"
              exit 1
            fi

            LINEAR_ID="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.id')"
            LINEAR_IDENTIFIER="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')"
            LINEAR_URL="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.url')"
            ACTION="created"
          fi

          echo "action=${ACTION}" >> "$GITHUB_OUTPUT"
          echo "linear_id=${LINEAR_ID}" >> "$GITHUB_OUTPUT"
          echo "linear_identifier=${LINEAR_IDENTIFIER}" >> "$GITHUB_OUTPUT"
          echo "linear_url=${LINEAR_URL}" >> "$GITHUB_OUTPUT"

      - name: Upsert PR comment with release tag status
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.pull_request.number;
            const commentId = `${{ steps.mapping.outputs.comment_id }}`;
            const linearId = `${{ steps.linear.outputs.linear_id }}`;
            const linearIdentifier = `${{ steps.linear.outputs.linear_identifier }}`;
            const linearUrl = `${{ steps.linear.outputs.linear_url }}`;
            const linearAction = `${{ steps.linear.outputs.action }}`;
            const tagAction = `${{ steps.tag.outputs.tag_action }}`;
            const tagName = `${{ steps.context.outputs.tag_name }}`;
            const tagUrl = `${{ steps.context.outputs.tag_url }}`;

            const body = [
              `<!-- linear-release-tag-ticket-id:${linearId} -->`,
              `<!-- linear-release-tag-ticket-identifier:${linearIdentifier} -->`,
              `<!-- linear-release-tag-ticket-url:${linearUrl} -->`,
              "Release merge tag automation executed.",
              "",
              `- Tag: ${tagName}`,
              `- Tag URL: ${tagUrl}`,
              `- Tag action: ${tagAction}`,
              `- Linear action: ${linearAction}`,
              `- Linear ticket: ${linearIdentifier}`,
              `- Linear URL: ${linearUrl}`,
            ].join("\n");

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: Number(commentId),
                body,
              });
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body,
            });
