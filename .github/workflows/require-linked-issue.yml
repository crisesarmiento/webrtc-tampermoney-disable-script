name: Require Linked Issue

on:
  pull_request:
    branches: [development, master]
    types: [opened, edited, reopened, synchronize]

jobs:
  require-linked-issue:
    if: ${{ !(github.event.pull_request.base.ref == 'master' && github.event.pull_request.head.ref == 'development') }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body includes closing issue reference
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if ! printf '%s\n' "$PR_BODY" | grep -Eiq '(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#([0-9]+)'; then
            echo "PR body must include a closing issue reference, for example: Closes #123"
            exit 1
          fi

      - name: Validate branch naming includes issue id
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          if printf '%s\n' "$HEAD_REF" | grep -Eq '^issue/[0-9]+-[a-z0-9._-]+$'; then
            exit 0
          fi

          if printf '%s\n' "$HEAD_REF" | grep -Eq '^codex/issue-[0-9]+-[a-z0-9._-]+$'; then
            exit 0
          fi

          echo "Branch name must match issue/<id>-<slug> or codex/issue-<id>-<slug>."
          exit 1
