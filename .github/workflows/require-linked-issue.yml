name: Require Linked Issue

on:
  pull_request:
    branches: [development, master]
    types: [opened, edited, reopened, synchronize]
  workflow_dispatch:
    inputs:
      strict_linear_enforcement:
        description: "Enable strict Linear enforcement for this manual run"
        required: false
        default: true
        type: boolean
      head_ref:
        description: "Head branch to validate (manual runs only)"
        required: false
        type: string
      base_ref:
        description: "Base branch to validate against (manual runs only)"
        required: false
        default: development
        type: string
      pr_title:
        description: "PR title to validate (manual runs only)"
        required: false
        type: string
      pr_body:
        description: "PR body to validate (manual runs only)"
        required: false
        type: string

jobs:
  require-linked-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      EVENT_NAME: ${{ github.event_name }}
      PR_HEAD_REF: ${{ github.head_ref }}
      PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_BODY: ${{ github.event.pull_request.body }}
      INPUT_STRICT: ${{ inputs.strict_linear_enforcement }}
      INPUT_HEAD_REF: ${{ inputs.head_ref }}
      INPUT_BASE_REF: ${{ inputs.base_ref }}
      INPUT_PR_TITLE: ${{ inputs.pr_title }}
      INPUT_PR_BODY: ${{ inputs.pr_body }}
      REPO_STRICT: ${{ vars.STRICT_LINEAR_ENFORCEMENT }}
    steps:
      - name: Validate Linear branch/title conventions
        run: |
          set -euo pipefail

          if [ "$EVENT_NAME" = "pull_request" ]; then
            HEAD_REF="$PR_HEAD_REF"
            BASE_REF="$PR_BASE_REF"
            PR_TITLE_VALUE="$PR_TITLE"
            PR_BODY_VALUE="$PR_BODY"
          else
            HEAD_REF="$INPUT_HEAD_REF"
            BASE_REF="$INPUT_BASE_REF"
            PR_TITLE_VALUE="$INPUT_PR_TITLE"
            PR_BODY_VALUE="$INPUT_PR_BODY"
          fi

          STRICT_EFFECTIVE="${INPUT_STRICT:-}"
          if [ -z "$STRICT_EFFECTIVE" ]; then
            STRICT_EFFECTIVE="${REPO_STRICT:-true}"
          fi
          STRICT_EFFECTIVE="$(printf '%s' "$STRICT_EFFECTIVE" | tr '[:upper:]' '[:lower:]')"

          if [ "$BASE_REF" = "master" ] && [ "$HEAD_REF" = "development" ]; then
            echo "Release PR exemption applied for development -> master."
            exit 0
          fi

          if [ "$STRICT_EFFECTIVE" != "true" ]; then
            echo "STRICT_LINEAR_ENFORCEMENT is disabled. Skipping Linear branch/title checks."
            exit 0
          fi

          if [ -z "$HEAD_REF" ]; then
            echo "Head branch reference is required for strict validation."
            exit 1
          fi

          if [ -z "$PR_TITLE_VALUE" ]; then
            echo "PR title is required for strict validation."
            exit 1
          fi

          if [[ ! "$HEAD_REF" =~ ^codex/([A-Z]+-[0-9]+)-[a-z0-9][a-z0-9._-]*$ ]]; then
            echo "Branch name must match codex/<TEAM>-<number>-<slug>."
            echo "Example: codex/CRIS-123-fix-stereo-gate"
            exit 1
          fi
          BRANCH_LINEAR_ID="${BASH_REMATCH[1]}"

          if [[ ! "$PR_TITLE_VALUE" =~ ^\[([A-Z]+-[0-9]+)\][[:space:]]+.+$ ]]; then
            echo "PR title must match [<TEAM>-<number>] <short title>."
            echo "Example: [CRIS-123] Fix stereo gate false positive"
            exit 1
          fi
          TITLE_LINEAR_ID="${BASH_REMATCH[1]}"

          if [ "$BRANCH_LINEAR_ID" != "$TITLE_LINEAR_ID" ]; then
            echo "Linear issue ID mismatch between branch and PR title."
            echo "Branch ID: $BRANCH_LINEAR_ID"
            echo "Title ID:  $TITLE_LINEAR_ID"
            exit 1
          fi

          MAGIC_IDS="$(printf '%s\n' "$PR_BODY_VALUE" | tr '[:lower:]' '[:upper:]' | grep -Eo '(CLOSE[SD]?|FIX(E[SD])?|RESOLVE[SD]?)[:[:space:]]+[A-Z]+-[0-9]+' | grep -Eo '[A-Z]+-[0-9]+' | sort -u || true)"
          if [ -n "$MAGIC_IDS" ]; then
            while IFS= read -r magic_id; do
              if [ "$magic_id" != "$BRANCH_LINEAR_ID" ]; then
                echo "Magic-word Linear ID must match branch/title ID."
                echo "Expected: $BRANCH_LINEAR_ID"
                echo "Found in body: $magic_id"
                exit 1
              fi
            done <<< "$MAGIC_IDS"
          fi

          echo "Linear branch/title policy validated successfully for $BRANCH_LINEAR_ID."
