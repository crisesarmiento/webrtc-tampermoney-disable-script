name: Sync Release Tag To Linear

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  sync-release-tag:
    runs-on: ubuntu-latest
    concurrency:
      group: linear-release-tag-${{ github.ref }}
      cancel-in-progress: false
    env:
      LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
      LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
      LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}
    steps:
      - name: Validate configuration
        run: |
          if [ -z "${LINEAR_API_KEY:-}" ]; then
            echo "Missing required secret: LINEAR_API_KEY"
            exit 1
          fi
          if [ -z "${LINEAR_TEAM_ID:-}" ]; then
            echo "Missing required secret: LINEAR_TEAM_ID"
            exit 1
          fi
          if [ -z "${LINEAR_PROJECT_ID:-}" ]; then
            echo "Missing required secret: LINEAR_PROJECT_ID"
            exit 1
          fi

      - name: Create Linear release tag ticket
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          TAG_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME}"
          COMMIT_SHA="${GITHUB_SHA}"

          LINEAR_TITLE="[Release Tag ${TAG_NAME}] ${GITHUB_REPOSITORY}"
          LINEAR_DESCRIPTION="$(printf '%s\n' \
            "Automated release tag tracking." \
            "" \
            "Repository: ${GITHUB_REPOSITORY}" \
            "Tag: ${TAG_NAME}" \
            "Release URL: ${TAG_URL}" \
            "Commit SHA: ${COMMIT_SHA}" \
            "Workflow run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            "Created at (UTC): $(date -u +%Y-%m-%dT%H:%M:%SZ)")"

          GRAPHQL_PAYLOAD="$(jq -n \
            --arg teamId "$LINEAR_TEAM_ID" \
            --arg projectId "$LINEAR_PROJECT_ID" \
            --arg title "$LINEAR_TITLE" \
            --arg description "$LINEAR_DESCRIPTION" \
            '{
              query: "mutation($input: IssueCreateInput!){ issueCreate(input:$input){ success issue { id identifier title url } } }",
              variables: {
                input: {
                  teamId: $teamId,
                  projectId: $projectId,
                  title: $title,
                  description: $description
                }
              }
            }'
          )"

          RESPONSE="$(curl -sS -X POST "https://api.linear.app/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: ${LINEAR_API_KEY}" \
            --data-binary "$GRAPHQL_PAYLOAD")"

          SUCCESS="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.success // false')"
          if [ "$SUCCESS" != "true" ]; then
            echo "Linear issueCreate failed:"
            echo "$RESPONSE"
            exit 1
          fi

          LINEAR_IDENTIFIER="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')"
          LINEAR_URL="$(printf '%s' "$RESPONSE" | jq -r '.data.issueCreate.issue.url')"

          echo "Created Linear release tag ticket: ${LINEAR_IDENTIFIER} (${LINEAR_URL})"
